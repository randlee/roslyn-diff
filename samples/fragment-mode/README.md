# HTML Fragment Mode Examples

This directory contains examples demonstrating roslyn-diff's HTML Fragment Mode, designed for embedding semantic diff reports into existing web applications.

## What's in This Directory

| File | Description |
|------|-------------|
| `fragment.html` | Example HTML fragment with embedded diff (no document wrapper) |
| `roslyn-diff.css` | External CSS stylesheet with all necessary styles |
| `parent.html` | Example parent page showing how to embed fragments |

## Quick Start

### ⚠️ Important: HTTP Server Required

**The `parent.html` example MUST be served via HTTP, not opened directly with `file://` protocol.**

The dynamic loading example uses JavaScript's `fetch()` API to load `fragment.html`, which is blocked by browser CORS (Cross-Origin Resource Sharing) security policies when using `file://` URLs.

**Quick Setup - Start Local HTTP Server:**

```bash
# Python 3 (built-in on macOS/Linux)
cd samples/fragment-mode
python3 -m http.server 8000
# Then open http://localhost:8000/parent.html

# Python 2 (if Python 3 not available)
cd samples/fragment-mode
python -m SimpleHTTPServer 8000

# Node.js (if npx available)
cd samples/fragment-mode
npx http-server -p 8000
# Then open http://localhost:8000/parent.html

# PHP (built-in server)
cd samples/fragment-mode
php -S localhost:8000
# Then open http://localhost:8000/parent.html
```

After starting the server, open your browser to `http://localhost:8000/parent.html`.

### Generate Your Own Fragment

```bash
# Basic fragment generation
roslyn-diff diff old.cs new.cs --html fragment.html --html-mode fragment

# Custom CSS filename
roslyn-diff diff old.cs new.cs --html fragment.html --html-mode fragment --extract-css custom.css
```

## Understanding the Files

### fragment.html

This is the HTML fragment generated by roslyn-diff in fragment mode. Key features:

- **No document wrapper**: No `<html>`, `<head>`, or `<body>` tags
- **External CSS**: Links to `roslyn-diff.css` instead of embedding styles
- **Root container**: `<div class="roslyn-diff-fragment">` wrapper
- **Data attributes**: Metadata for JavaScript integration

Structure:
```html
<link rel="stylesheet" href="roslyn-diff.css">

<div class="roslyn-diff-fragment"
     data-old-file="Calculator.cs"
     data-new-file="Calculator.cs"
     data-changes-total="4"
     data-changes-added="2"
     data-changes-removed="0"
     data-changes-modified="2"
     data-impact-breaking-public="0"
     data-impact-breaking-internal="0"
     data-impact-non-breaking="0"
     data-impact-formatting="0"
     data-mode="roslyn">
  <!-- Diff content here -->
</div>
```

### roslyn-diff.css

External stylesheet containing all styles needed for the diff visualization. Features:

- **CSS Custom Properties**: Variables for easy theming
- **Scoped Styles**: All rules target `.roslyn-diff-fragment` descendants
- **Responsive Design**: Works on mobile and desktop
- **Print Styles**: Optimized for printing
- **No Dependencies**: Self-contained, no external resources

Key variables you can override:
```css
:root {
  --color-added-bg: #e6ffec;
  --color-added-border: #2da44e;
  --color-removed-bg: #ffebe9;
  --color-removed-border: #cf222e;
  --color-modified-bg: #fff3cd;
  --color-modified-border: #bf8700;
  --font-mono: ui-monospace, SFMono-Regular, Menlo, monospace;
}
```

### parent.html

Example showing how to embed the fragment in a custom page. Demonstrates:

- **Loading fragment**: Static include or dynamic JavaScript loading
- **Custom header**: File-level metadata and navigation
- **Metadata extraction**: Reading data attributes with JavaScript
- **Multiple fragments**: Structure for embedding multiple diffs
- **Style customization**: Overriding fragment styles

## Integration Patterns

### Understanding CORS and HTTP Server Requirements

**When HTTP Server Is Required:**
- ✅ **Dynamic loading** (fetch, XMLHttpRequest) - MUST use HTTP server
- ✅ **ES6 module imports** - MUST use HTTP server
- ✅ **React/Vue/Angular development** - Already uses HTTP server (webpack-dev-server, etc.)

**When HTTP Server Is NOT Required:**
- ✅ **Server-side includes** (PHP, Node.js, Ruby) - Server handles file I/O
- ✅ **Static site generators** (Jekyll, Hugo, 11ty) - Build process handles includes
- ✅ **Static inline** - Fragment content copied directly into HTML
- ✅ **iframe embedding** - Browser allows same-directory file:// iframes

**Why CORS Blocks file:// URLs:**

Browsers enforce same-origin policy to prevent malicious websites from reading your local files. When you open HTML with `file://` protocol:
1. Origin is `null` (no domain)
2. `fetch()` requires same-origin or explicit CORS headers
3. Local files can't send CORS headers
4. Result: All cross-file fetch() calls are blocked

This is intentional browser security and cannot be disabled (except with unsafe browser flags, not recommended).

### Static Include (Server-Side)

**PHP:**
```php
<?php include('fragment.html'); ?>
```

**Node.js (EJS template):**
```ejs
<%- include('fragment.html') %>
```

**Ruby (ERB):**
```erb
<%= File.read('fragment.html') %>
```

**Python (Jinja2):**
```jinja
{% include 'fragment.html' %}
```

### Dynamic Loading (Client-Side)

**⚠️ Requires HTTP server** - Dynamic loading with `fetch()` does not work with `file://` URLs due to CORS restrictions. You must serve files via HTTP (see "HTTP Server Required" section).

**Vanilla JavaScript:**
```javascript
fetch('fragment.html')
  .then(response => response.text())
  .then(html => {
    document.getElementById('container').innerHTML = html;
  });
```

**jQuery:**
```javascript
$('#container').load('fragment.html');
```

**React:**
```jsx
function DiffViewer() {
  const [html, setHtml] = useState('');

  useEffect(() => {
    fetch('fragment.html')
      .then(r => r.text())
      .then(setHtml);
  }, []);

  return <div dangerouslySetInnerHTML={{ __html: html }} />;
}
```

## Accessing Metadata

The fragment root element has data attributes you can query with JavaScript:

```javascript
const fragment = document.querySelector('.roslyn-diff-fragment');

// Extract metadata
const stats = {
  oldFile: fragment.dataset.oldFile,
  newFile: fragment.dataset.newFile,
  totalChanges: parseInt(fragment.dataset.changesTotal),
  additions: parseInt(fragment.dataset.changesAdded),
  deletions: parseInt(fragment.dataset.changesRemoved),
  modifications: parseInt(fragment.dataset.changesModified),
  breakingPublic: parseInt(fragment.dataset.impactBreakingPublic),
  breakingInternal: parseInt(fragment.dataset.impactBreakingInternal),
  nonBreaking: parseInt(fragment.dataset.impactNonBreaking),
  formatting: parseInt(fragment.dataset.impactFormatting),
  mode: fragment.dataset.mode
};

console.log(`${stats.oldFile}: ${stats.totalChanges} changes`);

// Show warning if breaking changes exist
if (stats.breakingPublic > 0) {
  showAlert(`⚠️ Contains ${stats.breakingPublic} breaking API changes`);
}
```

## Styling and Theming

### Override Colors

Add your custom styles after loading `roslyn-diff.css`:

```html
<link rel="stylesheet" href="roslyn-diff.css">
<style>
  .roslyn-diff-fragment {
    --color-added-bg: #d4edda;
    --color-added-border: #28a745;
    --color-removed-bg: #f8d7da;
    --color-removed-border: #dc3545;
    --font-mono: 'Source Code Pro', monospace;
  }
</style>
```

### Hide Fragment Header

If you're adding your own header, hide the fragment's default header:

```css
.roslyn-diff-fragment header {
  display: none;
}
```

### Adjust Spacing

```css
.roslyn-diff-fragment {
  padding: 0;        /* Remove padding */
  border: none;      /* Remove border */
  border-radius: 0;  /* Remove rounded corners */
  margin: 0;         /* Remove margin */
}
```

## Use Cases

### Documentation Sites

Embed diffs in Markdown-based documentation:

```markdown
# Changelog

## v2.0.0 - API Changes

<div id="api-diff"></div>
<script>
  fetch('/diffs/v1-to-v2-api.html')
    .then(r => r.text())
    .then(html => document.getElementById('api-diff').innerHTML = html);
</script>
```

### Code Review Dashboards

Build custom review interfaces:

```html
<!-- Multiple diffs in tabs or accordion -->
<div class="review-dashboard">
  <ul class="file-tabs">
    <li><a href="#diff-1">Calculator.cs</a></li>
    <li><a href="#diff-2">Service.cs</a></li>
    <li><a href="#diff-3">Controller.cs</a></li>
  </ul>

  <div id="diff-1"><?php include('diffs/calculator.html'); ?></div>
  <div id="diff-2"><?php include('diffs/service.html'); ?></div>
  <div id="diff-3"><?php include('diffs/controller.html'); ?></div>
</div>
```

### CI/CD Reports

Display diff in build pipeline dashboards:

```html
<!-- Build pipeline report -->
<div class="pipeline-stage">
  <h2>Code Changes - Build #42</h2>
  <div class="stage-content">
    <?php include("builds/{$buildId}/diff.html"); ?>
  </div>
</div>
```

### Static Site Generators

Generate diffs during site build (Jekyll example):

```liquid
---
layout: default
title: "v2.0 Upgrade Guide"
---

## Breaking Changes

{% include_relative _diffs/v1-to-v2.html %}
```

## Multi-File Example

Embedding multiple fragments in one page:

```html
<!DOCTYPE html>
<html>
<head>
  <title>Multi-File Review</title>
  <link rel="stylesheet" href="roslyn-diff.css">
</head>
<body>
  <h1>Pull Request #123</h1>

  <!-- File 1 -->
  <section class="file-diff">
    <h2>Calculator.cs</h2>
    <?php include('diffs/calculator-fragment.html'); ?>
  </section>

  <!-- File 2 -->
  <section class="file-diff">
    <h2>Service.cs</h2>
    <?php include('diffs/service-fragment.html'); ?>
  </section>

  <!-- File 3 -->
  <section class="file-diff">
    <h2>Controller.cs</h2>
    <?php include('diffs/controller-fragment.html'); ?>
  </section>
</body>
</html>
```

All fragments share the same `roslyn-diff.css`, so CSS is only loaded once.

## Advantages Over Document Mode

| Feature | Document Mode | Fragment Mode |
|---------|--------------|---------------|
| Standalone | ✅ Yes | ❌ Needs parent page |
| Embedded | ❌ No | ✅ Yes |
| Custom Styling | ⚠️ Hard (CSS override) | ✅ Easy (CSS variables) |
| Multiple Diffs | ⚠️ Separate files | ✅ Shared CSS |
| JavaScript Access | ❌ No metadata | ✅ Data attributes |
| File Size | Larger (CSS inline) | Smaller (CSS separate) |
| Browser Caching | ❌ No (inline CSS) | ✅ Yes (external CSS) |

## Troubleshooting

### "Failed to load diff fragment" Error

**Problem**: The parent.html shows "Failed to load diff fragment" or browser console shows CORS errors like:
```
Access to fetch at 'file:///path/to/fragment.html' from origin 'null' has been blocked by CORS policy
```

**Cause**: Modern browsers block `fetch()` calls to local files (`file://` protocol) due to CORS security restrictions. This is intentional browser security to prevent malicious websites from reading your local files.

**Solution**: Use an HTTP server (see "HTTP Server Required" section above). The examples were designed for real-world web application scenarios where files are always served via HTTP.

**Why This Happens**:
- `file://` URLs have `null` origin
- `fetch()` API enforces same-origin policy
- Cross-origin requests from `null` are always blocked
- This affects ALL client-side dynamic loading (fetch, XMLHttpRequest, ES modules)

**Alternatives That Work with `file://`**:
1. **Static inline** - Copy fragment.html content directly into parent.html (no fetch needed)
2. **iframe** - Use `<iframe src="fragment.html">` (works with file://)
3. **Server-side includes** - Use PHP/Node.js/etc includes (requires server anyway)

### Fragment Not Displaying

1. **Check CSS path**: Ensure `roslyn-diff.css` is in the same directory as the HTML
2. **Check browser console**: Look for 404 errors or CSS loading issues
3. **Verify fragment structure**: Should have `<div class="roslyn-diff-fragment">`
4. **Verify HTTP server**: Make sure you're accessing via `http://` not `file://`

### Styles Conflicting

1. **Use CSS specificity**: Target `.roslyn-diff-fragment .your-class`
2. **Check CSS load order**: Load `roslyn-diff.css` before your custom styles
3. **Use CSS variables**: Override colors via `--color-*` properties

### Data Attributes Not Accessible

1. **Check timing**: Wait for DOM load (`DOMContentLoaded` event)
2. **Verify selector**: Use `.roslyn-diff-fragment` not `.roslyn-diff`
3. **Parse integers**: Use `parseInt()` for numeric attributes

## Further Reading

- [Output Formats Guide](../../docs/output-formats.md) - Complete documentation on HTML fragment mode
- [roslyn-diff README](../../README.md) - Main project documentation
- [CLI Usage Guide](../../docs/usage.md) - Command-line options

## Generating These Examples

The files in this directory were generated with:

```bash
# Generate fragment
roslyn-diff diff ../before/Calculator.cs ../after/Calculator.cs \
  --html fragment.html \
  --html-mode fragment

# Result: fragment.html + roslyn-diff.css
```

The `parent.html` file was hand-crafted to demonstrate embedding patterns.
